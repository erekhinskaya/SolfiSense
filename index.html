<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Memory Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .piano {
            display: flex;
            align-items: flex-start;
            position: relative;
            margin-top: 20px;
        }

        .octave {
            position: relative;
            display: flex;
        }

        .white-key {
            width: 40px;
            height: 200px;
            background-color: white;
            border: 1px solid #333;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
        }

        .black-key {
            width: 25px;
            height: 120px;
            background-color: black;
            position: absolute;
            top: 0;
            margin-left: -12.5px;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-size: 0.7em;
            z-index: 1;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 font-sans p-5">
    <h1 class="text-2xl font-bold mb-5">Melody Memory Game</h1>

    <div class="controls mb-5 space-x-4">
        <label class="space-x-2">
            <span>Sequence Length:</span>
            <input type="number" id="sequenceLength" value="5" min="1" class="border rounded p-1">
        </label>
        <label class="space-x-2">
            <span>First Note:</span>
            <input type="text" id="firstNote" value="C2" class="border rounded p-1">
        </label>
        <label class="space-x-2">
            <span>Last Note:</span>
            <input type="text" id="lastNote" value="C5" class="border rounded p-1">
        </label>
        <button onclick="generateSequence()" class="bg-blue-500 text-white px-4 py-2 rounded">Generate Sequence</button>
        <button onclick="playSequence()" class="bg-green-500 text-white px-4 py-2 rounded">Play Sequence</button>
    </div>

    <div class="piano" id="pianoKeyboard"></div>

    <div class="mt-5">
        <label class="block text-lg font-semibold mb-2">Your Attempt:</label>
        <input type="text" id="userInput" class="border rounded p-2 w-full mb-3" placeholder="Type your answer here">
        <button onclick="checkSequence()" class="bg-purple-500 text-white px-4 py-2 rounded">Check</button>
    </div>

    <div id="result" class="mt-4 text-xl font-bold"></div>

    <script>
        const octaves = [2, 3, 4, 5];  // Adjusted to span from C2 to C5
        const noteFrequencies = {
            'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13, 'E': 329.63,
            'F': 349.23, 'F#': 369.99, 'G': 392.00, 'G#': 415.30, 'A': 440.00,
            'A#': 466.16, 'B': 493.88
        };
        let generatedSequence = [];
        let selectedNotes = [];

        function generateSequence() {
            const sequenceLength = parseInt(document.getElementById("sequenceLength").value);
            const firstNote = document.getElementById("firstNote").value;
            const lastNote = document.getElementById("lastNote").value;

            selectedNotes = getNotesInRange(firstNote, lastNote);
            generatedSequence = [];
            for (let i = 0; i < sequenceLength; i++) {
                const randomNote = selectedNotes[Math.floor(Math.random() * selectedNotes.length)];
                generatedSequence.push(randomNote);
            }
            document.getElementById("result").innerText = "New sequence generated!";
        }

        async function playSequence() {
            if (generatedSequence.length === 0) {
                generateSequence();
            }
            for (const note of generatedSequence) {
                await playNoteSound(note);
            }
        }

        function playNoteSound(note) {
            return new Promise((resolve) => {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                oscillator.type = "sine";
                oscillator.frequency.value = noteFrequencies[note.slice(0, -1)] * Math.pow(2, parseInt(note.slice(-1)) - 4);
                oscillator.connect(audioCtx.destination);
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    resolve();
                }, 500);
            });
        }

        function checkSequence() {
            const userInput = document.getElementById("userInput").value.trim().split(" ");
            const isCorrect = userInput.length === generatedSequence.length &&
                userInput.every((note, i) => note === generatedSequence[i]);

            document.getElementById("result").innerText = isCorrect ? "Correct! Generating new sequence..." : "Incorrect. Try again!";

            if (isCorrect) {
                setTimeout(generateSequence, 1000);
            }
        }

        function getNotesInRange(firstNote, lastNote) {
            const allNotes = [];
            let addNotes = false;

            octaves.forEach(octave => {
                for (const note in noteFrequencies) {
                    const fullNote = note + octave;
                    if (fullNote === firstNote) addNotes = true;
                    if (addNotes) allNotes.push(fullNote);
                    if (fullNote === lastNote) addNotes = false;
                }
            });
            return allNotes;
        }

        function setupPiano() {
            const piano = document.getElementById("pianoKeyboard");

            octaves.forEach(octave => {
                const octaveDiv = document.createElement("div");
                octaveDiv.className = "octave";

                const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const blackNotes = { 'C': 'C#', 'D': 'D#', 'F': 'F#', 'G': 'G#', 'A': 'A#' };

                whiteNotes.forEach((note, index) => {
                    const whiteKey = document.createElement("div");
                    whiteKey.className = "white-key";
                    whiteKey.onclick = () => playNoteSound(note + octave);
                    whiteKey.innerText = note + octave;
                    octaveDiv.appendChild(whiteKey);

                    if (blackNotes[note]) {
                        const blackKey = document.createElement("div");
                        blackKey.className = "black-key";
                        blackKey.style.left = `${(index * 40) + 30}px`; // Position black keys accurately
                        blackKey.onclick = () => playNoteSound(blackNotes[note] + octave);
                        blackKey.innerText = blackNotes[note] + octave;
                        octaveDiv.appendChild(blackKey);
                    }
                });

                piano.appendChild(octaveDiv);
            });
        }

        setupPiano();
    </script>
</body>

</html>